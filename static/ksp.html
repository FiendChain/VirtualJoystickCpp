<!DOCTYPE HTML>
<html>
  <head>
    <title>KSP</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="/css/led.css">
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no' />
  </head>
  <body>
    <!--Controller GUI area (fixed size for Honor Play)-->
    <div class="gui-region" style="width:750px;height:360px">
      <!-- Top control row -->
      <div class="d-flex flex-row" style="height:200px;margin-bottom:5px">
        <!-- Primary control stick -->
        <div class="control-surface round-border" id="joystick_primary" style="width:200px;height:200px"></div>
        <!-- Quick access buttons -->
        <div class="mx-auto">
          <div class="grid-container" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
            <!-- Row -->
            <button class="btn btn-toggle app_toggle_btn" attr-state="false" value="0">BRAKE</button>
            <button class="btn btn-momentary app_btn" value="1">GEAR</button>
            <!-- Row -->
            <button class="btn btn-momentary app_btn" value="2">LIGHT</button>
            <button class="btn btn-momentary app_btn" value="3">MAP</button>
            <!-- Row -->
            <button class="btn btn-momentary app_btn" value="4">SAS</button>
            <button class="btn btn-momentary app_btn" value="5">RCS</button>
            <!-- Row -->
            <label class="text-center" style="grid-column: span 2">⇙ TIME WARP ⇘</label>
            <button class="btn btn-momentary app_btn" value="6">BACKWARD</button>
            <button class="btn btn-momentary app_btn" value="7">FORWARD</button>
            <!-- Row -->
            <button class="btn app_modal_btn" attr-modal-id="modal-quicksave" style="grid-column: span 2">QUICKSAVE</button>
          </div>
        </div>
        <!-- Common slider controls -->
        <div class="d-flex flex-row mr-auto">
          <div class="flex-grow-1">
            <div class="d-flex flex-col h-100">
              <div class="control-surface round-border mx-auto" id="slider_throttle"  attr-value="-100" attr-orient="vertical" style="height:180px;width:45px"></div>
              <label class="text-center">THROTTLE</label>
            </div>
          </div>
        </div>
        <!-- Rudder + Secondary control stick -->
        <div class="d-flex flex-col">
          <!-- Secondary joystick -->
          <div class="control-surface round-border" id="joystick_secondary" style="width:200px;height:150px"></div>
          <!-- Rudder -->
          <div class="d-flex flex-row mt-auto" style="height:45px">
            <button class="btn btn-toggle" id="slider_rudder_spring" style="padding-left:4px;padding-right:4px;margin-right:4px" attr-state="true">R</button>
            <div class="control-surface round-border flex-grow-1" id="slider_rudder" attr-value="0" attr-spring="0" style="height:100%"></div>
          </div>
        </div>
      </div>
      <!-- Bottom control row -->
      <div class="d-flex flex-row">
        <div class="grid-container" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
          <!-- Row -->
          <button class="btn btn-momentary app_btn" value="8">MENU</button>
          <button class="btn btn-momentary app_btn" value="9">CAMERA</button>
          <!-- Row -->
          <button class="btn app_modal_btn" attr-modal-id="modal-stage" style="grid-column: span 2">STAGE</button>
          <!-- Row -->
          <button class="btn app_modal_btn" attr-modal-id="modal-abort" style="grid-column: span 2">ABORT</button>
        </div>
      </div>
      <!-- Floating status bar on bottom right -->
      <div class="status-bar">
        <div class="d-flex flex-row">
          <div class="btn-group">
            <button class="btn" onClick="window.location.href='/index.html'">⌂</button>
            <button class="btn" id="btn_get_screen_size">?</button>
            <button class="btn" id="btn_reset_device">↻</button>
            <button class="btn" id="btn_fullscreen">⛶</button>
          </div>
          <div class="status-led" id="status-led"></div>
        </div>
      </div>
      <!--Modals-->
      <div class="modal" id="modal-stage">
        <div class="modal-dialog">
          <header class="modal-header">
            <h3 class="modal-title text-center">STAGE SEPARATION</h3>
          </header>
          <footer class="modal-footer">
            <button class="btn btn-momentary w-100" id="confirm" value="10">CONFIRM</button>
          </footer>
        </div>
      </div>
      <div class="modal" id="modal-abort">
        <div class="modal-dialog">
          <header class="modal-header">
            <h3 class="modal-title text-center">ABORT</h3>
          </header>
          <footer class="modal-footer">
            <button class="btn btn-momentary w-100" id="confirm" value="11">CONFIRM</button>
          </footer>
        </div>
      </div>
      <div class="modal" id="modal-quicksave">
        <div class="modal-dialog">
          <header class="modal-header">
            <h3 class="modal-title text-center">PERFORM QUICKSAVE</h3>
          </header>
          <footer class="modal-footer">
            <button class="btn btn-momentary w-100" id="confirm" value="12">CONFIRM</button>
          </footer>
        </div>
      </div>
    </div>
    
    <!-- Glue code -->
    <script type="module">
      import { App, Axis } from "/js/app.js";
      import { toggle_fullscreen } from "/js/fullscreen.js";
      import { JoyStick } from "/js/joystick.js";
      import { Slider } from "/js/slider.js";
      import { Button } from "/js/button.js";
      import { ToggleButton } from "/js/toggle_button.js";
      import { Modal } from "/js/modal.js";

      // App slider with toggle control for spring
      let create_toggle_slider = (slider_id, button_id) => {
        let slider = new Slider(document.getElementById(slider_id));
        let button = new ToggleButton(document.getElementById(button_id));
        button.on_change.add(state => {
          slider.set_spring_mode(state);
        });
        button.force_update();
        return slider;
      };

      // App modal controls
      let create_modal_button = trigger_button_elem => {
        let modal_id = trigger_button_elem.getAttribute("attr-modal-id");
        let modal_elem = document.getElementById(modal_id);
        let confirm_button_elem = modal_elem.querySelector("#confirm");
        let button_id = Number(confirm_button_elem.getAttribute("value"));
        let modal = new Modal(modal_elem);
        let confirm_button = new Button(confirm_button_elem);
        // Trigger button
        trigger_button_elem.addEventListener("click", ev => {
          ev.preventDefault();
          modal.show();
        });
        // Confirm button
        confirm_button.on_change.add(state => {
          if (state) {
            modal.hide();
          }
        });
        return { button: confirm_button, button_id };
      };

      let attach_controls = app => {
        // Manually add joysticks
        app.add_joystick(new JoyStick('joystick_primary'), Axis.X, Axis.Y);
        app.add_joystick(new JoyStick('joystick_secondary'), Axis.RX, Axis.RY);
        app.add_slider(create_toggle_slider("slider_rudder", "slider_rudder_spring"), Axis.Z);
        app.add_slider(new Slider(document.getElementById('slider_throttle')), Axis.THROTTLE);

        // Automatically add buttons
        let app_buttons = document.getElementsByClassName("app_btn");
        for (let elem of app_buttons) {
          let button_id = Number(elem.getAttribute("value"));
          let button = new Button(elem);
          app.add_button(button, button_id);
        }

        let app_toggle_buttons = document.getElementsByClassName("app_toggle_btn");
        for (let elem of app_toggle_buttons) {
          let button_id = Number(elem.getAttribute("value"));
          let button = new ToggleButton(elem);
          app.add_button(button, button_id);
        }

        let app_modal_buttons = document.getElementsByClassName("app_modal_btn");
        for (let elem of app_modal_buttons) {
          let { button, button_id } = create_modal_button(elem, app);
          app.add_button(button, button_id);
        }
      };

      // Create app
      let device_id = 1;
      let app = new App(device_id);
      attach_controls(app);

      // Extra controls
      document.getElementById("btn_get_screen_size").onclick = ev => {
        ev.preventDefault();
        let body = document.getElementsByTagName('body')[0];
        let x = window.innerWidth || document.documentElement.clientWidth || body.clientWidth;
        let y = window.innerHeight|| document.documentElement.clientHeight|| body.clientHeight;
        alert(`Screen size: (${x},${y})`);
      };

      document.getElementById("btn_reset_device").onclick = ev => {
        ev.preventDefault();
        app.reset_device();
      };

      document.getElementById("btn_fullscreen").onclick = ev => {
        ev.preventDefault();
        toggle_fullscreen();
      };

      // Status led
      let status_led = document.getElementById("status-led");
      status_led.className = "status-led led-yellow";
      app.on_connection_change = is_open => {
        if (is_open) {
          status_led.className = "status-led led-green";
        } else {
          status_led.className = "status-led led-red";
          // alert("Websocket has closed");
        }
      };

      // Start app after setup
      app.start();
      window.app = app;
    </script>
  </body>
</html>